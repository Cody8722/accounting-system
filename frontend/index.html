<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° å€‹äººè¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®šå¾Œç«¯ URLï¼ˆæ ¹æ“šéƒ¨ç½²ç’°å¢ƒèª¿æ•´ï¼‰
        window.BACKEND_URL = 'http://localhost:5001';
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
        }

        /* ç™»å…¥å°è©±æ¡†æ¨£å¼ */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        #login-modal.hidden { display: none; }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="p-0">
    <!-- ç™»å…¥å°è©±æ¡† -->
    <div id="login-modal">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="text-4xl mb-3">ğŸ”</div>
                <h2 class="text-2xl font-bold text-gray-800">ç®¡ç†å“¡ç™»å…¥</h2>
                <p class="text-gray-500 mt-2">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥å­˜å–è¨˜å¸³æœ¬</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">ç®¡ç†å“¡å¯†ç¢¼</label>
                    <input type="password" id="admin-password"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                           placeholder="è«‹è¼¸å…¥ ADMIN_SECRET"
                           required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit"
                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 font-semibold transition">
                    ç™»å…¥
                </button>
            </form>
        </div>
    </div>

    <!-- ä¸»å…§å®¹ -->
    <div class="container mx-auto p-4 sm:p-8" id="main-content" style="display: none;">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ’° å€‹äººè¨˜å¸³æœ¬</h1>
            <p class="text-purple-100">è¼•é¬†ç®¡ç†æ‚¨çš„æ”¶æ”¯ï¼ŒæŒæ¡è²¡å‹™ç‹€æ³</p>
        </div>

        <div class="max-w-7xl mx-auto space-y-6">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                    <p class="text-sm text-green-600 mb-1">ğŸ’° æœ¬æœˆæ”¶å…¥</p>
                    <p id="total-income" class="text-3xl font-bold text-green-700">$0</p>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-lg shadow-lg border-l-4 border-red-500">
                    <p class="text-sm text-red-600 mb-1">ğŸ’¸ æœ¬æœˆæ”¯å‡º</p>
                    <p id="total-expense" class="text-3xl font-bold text-red-700">$0</p>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
                    <p class="text-sm text-blue-600 mb-1">ğŸ“Š çµé¤˜</p>
                    <p id="balance" class="text-3xl font-bold text-blue-700">$0</p>
                </div>
            </div>

            <!-- æ–°å¢è¨˜å¸³èˆ‡é ç®— -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                <!-- æ–°å¢è¨˜å¸³è¡¨å–® -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="text-2xl mr-2">â•</span>
                        æ–°å¢è¨˜å¸³
                    </h2>
                    <form id="accounting-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é¡å‹</label>
                                <select id="record-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                                    <option value="expense">æ”¯å‡º</option>
                                    <option value="income">æ”¶å…¥</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
                                <input type="number" id="record-amount" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" placeholder="0" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é¡</label>
                                <select id="record-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                                    <option value="æ—©é¤">æ—©é¤</option>
                                    <option value="åˆé¤">åˆé¤</option>
                                    <option value="æ™šé¤">æ™šé¤</option>
                                    <option value="é»å¿ƒ">é»å¿ƒ</option>
                                    <option value="é£²æ–™">é£²æ–™</option>
                                    <option value="æ”¶å…¥">æ”¶å…¥</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
                                <input type="date" id="record-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æè¿° (é¸å¡«)</label>
                            <input type="text" id="record-description" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500" placeholder="ä¾‹å¦‚ï¼šä¾¿åˆ©å•†åº—">
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="is-recurring" class="h-4 w-4 text-purple-600 rounded">
                                <span class="text-sm text-gray-700">é‡è¤‡è¨˜å¸³</span>
                            </label>
                            <select id="recurring-type" class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-purple-500 disabled:bg-gray-100" disabled>
                                <option value="daily">æ¯æ—¥</option>
                                <option value="weekly">æ¯é€±</option>
                                <option value="monthly">æ¯æœˆ</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 font-semibold transition shadow-md">
                            æ–°å¢è¨˜å¸³
                        </button>
                        <div id="accounting-message" class="text-center text-sm font-medium hidden"></div>
                    </form>
                </div>

                <!-- é ç®—è¨­å®š -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ¯</span>
                        æœ¬æœˆé ç®—
                    </h2>
                    <div id="budget-form" class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">æ—©é¤</label>
                            <input type="number" data-category="æ—©é¤" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">åˆé¤</label>
                            <input type="number" data-category="åˆé¤" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">æ™šé¤</label>
                            <input type="number" data-category="æ™šé¤" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">é»å¿ƒ</label>
                            <input type="number" data-category="é»å¿ƒ" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">é£²æ–™</label>
                            <input type="number" data-category="é£²æ–™" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">å…¶ä»–</label>
                            <input type="number" data-category="å…¶ä»–" class="budget-input w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500" placeholder="0">
                        </div>
                        <button id="save-budget-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-semibold text-sm transition shadow-md">
                            å„²å­˜é ç®—
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¯©é¸å™¨ -->
            <div class="bg-white p-4 rounded-lg shadow-lg fade-in">
                <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="filter-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="filter-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¡å‹</label>
                        <select id="filter-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                            <option value="">å…¨éƒ¨</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[120px]">
                        <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†é¡</label>
                        <select id="filter-category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                            <option value="">å…¨éƒ¨</option>
                            <option value="æ—©é¤">æ—©é¤</option>
                            <option value="åˆé¤">åˆé¤</option>
                            <option value="æ™šé¤">æ™šé¤</option>
                            <option value="é»å¿ƒ">é»å¿ƒ</option>
                            <option value="é£²æ–™">é£²æ–™</option>
                            <option value="æ”¶å…¥">æ”¶å…¥</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <button id="load-records-btn" class="bg-purple-600 text-white px-6 py-2 rounded-md hover:bg-purple-700 font-semibold transition shadow-md">
                        æŸ¥è©¢
                    </button>
                </div>
            </div>

            <!-- è¨˜å¸³è¨˜éŒ„åˆ—è¡¨ -->
            <div class="bg-white p-6 rounded-lg shadow-lg fade-in">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ“</span>
                    è¨˜å¸³è¨˜éŒ„
                </h2>
                <div id="records-list" class="space-y-2">
                    <p class="text-center text-gray-500 py-8">é»æ“Šã€ŒæŸ¥è©¢ã€è¼‰å…¥è¨˜éŒ„</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const backendUrl = window.BACKEND_URL || 'http://localhost:5001';

        // --- å¯†ç¢¼ç®¡ç† ---
        function getAdminSecret() {
            return sessionStorage.getItem('adminSecret') || '';
        }

        function setAdminSecret(secret) {
            sessionStorage.setItem('adminSecret', secret);
        }

        // --- ç™»å…¥åŠŸèƒ½ ---
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginError = document.getElementById('login-error');
        const mainContent = document.getElementById('main-content');

        async function verifyPassword(password) {
            try {
                const response = await fetch(`${backendUrl}/status`, {
                    headers: { 'X-Admin-Secret': password }
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = adminPasswordInput.value.trim();

            if (!password) {
                loginError.textContent = 'è«‹è¼¸å…¥å¯†ç¢¼';
                loginError.classList.remove('hidden');
                return;
            }

            loginError.textContent = 'é©—è­‰ä¸­...';
            loginError.classList.remove('hidden');
            loginError.classList.remove('text-red-500');
            loginError.classList.add('text-gray-500');

            const isValid = await verifyPassword(password);

            if (isValid) {
                setAdminSecret(password);
                loginModal.classList.add('hidden');
                mainContent.style.display = 'block';

                // åˆå§‹åŒ–è¨˜å¸³åŠŸèƒ½
                setTodayAsDefault();
                loadBudget();
            } else {
                loginError.textContent = 'âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';
                loginError.classList.remove('text-gray-500');
                loginError.classList.add('text-red-500');
                adminPasswordInput.value = '';
            }
        });

        // --- è¨˜å¸³åŠŸèƒ½ ---
        const accountingForm = document.getElementById('accounting-form');
        const recordType = document.getElementById('record-type');
        const recordAmount = document.getElementById('record-amount');
        const recordCategory = document.getElementById('record-category');
        const recordDate = document.getElementById('record-date');
        const recordDescription = document.getElementById('record-description');
        const isRecurring = document.getElementById('is-recurring');
        const recurringType = document.getElementById('recurring-type');
        const accountingMessage = document.getElementById('accounting-message');
        const loadRecordsBtn = document.getElementById('load-records-btn');
        const saveBudgetBtn = document.getElementById('save-budget-btn');
        const recordsList = document.getElementById('records-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const balanceEl = document.getElementById('balance');

        // è¨­å®šä»Šå¤©çš„æ—¥æœŸç‚ºé è¨­å€¼
        function setTodayAsDefault() {
            const today = new Date().toISOString().split('T')[0];
            recordDate.value = today;
            document.getElementById('filter-start-date').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('filter-end-date').value = today;
        }

        // å•Ÿç”¨/åœç”¨é‡è¤‡è¨˜å¸³é¡å‹
        isRecurring.addEventListener('change', () => {
            recurringType.disabled = !isRecurring.checked;
        });

        // æ ¹æ“šé¡å‹æ›´æ–°åˆ†é¡é¸é …
        recordType.addEventListener('change', () => {
            if (recordType.value === 'income') {
                recordCategory.value = 'æ”¶å…¥';
            } else {
                if (recordCategory.value === 'æ”¶å…¥') {
                    recordCategory.value = 'æ—©é¤';
                }
            }
        });

        // æ–°å¢è¨˜å¸³è¨˜éŒ„
        accountingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const secret = getAdminSecret();

            const recordData = {
                type: recordType.value,
                amount: parseFloat(recordAmount.value),
                category: recordCategory.value,
                date: recordDate.value,
                description: recordDescription.value,
                is_recurring: isRecurring.checked,
                recurring_type: isRecurring.checked ? recurringType.value : null
            };

            try {
                const response = await fetch(`${backendUrl}/admin/api/accounting/records`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Secret': secret
                    },
                    body: JSON.stringify(recordData)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'æ–°å¢å¤±æ•—');

                accountingMessage.textContent = 'âœ… è¨˜å¸³è¨˜éŒ„å·²æ–°å¢';
                accountingMessage.className = 'text-center text-sm font-medium text-green-600';
                accountingMessage.classList.remove('hidden');

                // æ¸…ç©ºè¡¨å–®
                recordAmount.value = '';
                recordDescription.value = '';
                isRecurring.checked = false;
                recurringType.disabled = true;
                setTodayAsDefault();

                // é‡æ–°è¼‰å…¥è¨˜éŒ„å’Œçµ±è¨ˆ
                loadAccountingRecords();
                updateAccountingStats();

                setTimeout(() => {
                    accountingMessage.classList.add('hidden');
                }, 3000);
            } catch (error) {
                accountingMessage.textContent = `âŒ ${error.message}`;
                accountingMessage.className = 'text-center text-sm font-medium text-red-600';
                accountingMessage.classList.remove('hidden');
            }
        });

        // è¼‰å…¥è¨˜å¸³è¨˜éŒ„
        async function loadAccountingRecords() {
            const secret = getAdminSecret();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const filterType = document.getElementById('filter-type').value;
            const filterCategory = document.getElementById('filter-category').value;

            let url = `${backendUrl}/admin/api/accounting/records?`;
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}&`;
            if (filterType) url += `type=${filterType}&`;
            if (filterCategory) url += `category=${filterCategory}&`;

            recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">â³ è¼‰å…¥ä¸­...</p>';

            try {
                const response = await fetch(url, {
                    headers: { 'X-Admin-Secret': secret }
                });

                const records = await response.json();
                if (!response.ok) throw new Error(records.error || 'è¼‰å…¥å¤±æ•—');

                if (records.length === 0) {
                    recordsList.innerHTML = '<p class="text-center text-gray-500 py-8">ç›®å‰æ²’æœ‰è¨˜éŒ„</p>';
                    return;
                }

                recordsList.innerHTML = records.map(record => {
                    const typeClass = record.type === 'income' ? 'text-green-600' : 'text-red-600';
                    const typeIcon = record.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸';
                    const recurringBadge = record.is_recurring ? `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded ml-2">ğŸ”„ ${record.recurring_type === 'daily' ? 'æ¯æ—¥' : record.recurring_type === 'weekly' ? 'æ¯é€±' : 'æ¯æœˆ'}</span>` : '';

                    return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${typeIcon}</span>
                                    <div>
                                        <p class="font-medium ${typeClass}">$${record.amount.toFixed(2)}</p>
                                        <p class="text-sm text-gray-600">${record.category}${record.description ? ' - ' + record.description : ''}</p>
                                        <p class="text-xs text-gray-500">${record.date}${recurringBadge}</p>
                                    </div>
                                </div>
                            </div>
                            <button onclick="deleteAccountingRecord('${record._id.$oid}')" class="text-red-500 hover:text-red-700 px-3 py-1 rounded-md hover:bg-red-50 text-sm font-medium">
                                åˆªé™¤
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                recordsList.innerHTML = `<p class="text-center text-red-500 py-8">âŒ ${error.message}</p>`;
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        async function updateAccountingStats() {
            const secret = getAdminSecret();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            let url = `${backendUrl}/admin/api/accounting/stats?`;
            if (startDate) url += `start_date=${startDate}&`;
            if (endDate) url += `end_date=${endDate}`;

            try {
                const response = await fetch(url, {
                    headers: { 'X-Admin-Secret': secret }
                });

                const stats = await response.json();
                if (!response.ok) throw new Error(stats.error || 'è¼‰å…¥å¤±æ•—');

                totalIncomeEl.textContent = `$${stats.total_income.toFixed(2)}`;
                totalExpenseEl.textContent = `$${stats.total_expense.toFixed(2)}`;
                balanceEl.textContent = `$${stats.balance.toFixed(2)}`;
                balanceEl.className = `text-3xl font-bold ${stats.balance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // åˆªé™¤è¨˜å¸³è¨˜éŒ„
        window.deleteAccountingRecord = async function(recordId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;

            const secret = getAdminSecret();

            try {
                const response = await fetch(`${backendUrl}/admin/api/accounting/records/${recordId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Secret': secret }
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'åˆªé™¤å¤±æ•—');

                // é‡æ–°è¼‰å…¥è¨˜éŒ„å’Œçµ±è¨ˆ
                loadAccountingRecords();
                updateAccountingStats();
            } catch (error) {
                alert(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`);
            }
        };

        // è¼‰å…¥é ç®—è¨­å®š
        async function loadBudget() {
            const secret = getAdminSecret();

            try {
                const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                    headers: { 'X-Admin-Secret': secret }
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');

                if (result.budget) {
                    document.querySelectorAll('.budget-input').forEach(input => {
                        const category = input.dataset.category;
                        if (result.budget[category] !== undefined) {
                            input.value = result.budget[category];
                        }
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥é ç®—å¤±æ•—:', error);
            }
        }

        // å„²å­˜é ç®—è¨­å®š
        saveBudgetBtn.addEventListener('click', async () => {
            const secret = getAdminSecret();
            const budget = {};

            document.querySelectorAll('.budget-input').forEach(input => {
                const category = input.dataset.category;
                const amount = parseFloat(input.value) || 0;
                budget[category] = amount;
            });

            saveBudgetBtn.disabled = true;
            saveBudgetBtn.textContent = 'å„²å­˜ä¸­...';

            try {
                const response = await fetch(`${backendUrl}/admin/api/accounting/budget`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Secret': secret
                    },
                    body: JSON.stringify({ budget })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'å„²å­˜å¤±æ•—');

                saveBudgetBtn.textContent = 'âœ… å·²å„²å­˜';
                setTimeout(() => {
                    saveBudgetBtn.textContent = 'å„²å­˜é ç®—';
                    saveBudgetBtn.disabled = false;
                }, 2000);
            } catch (error) {
                alert(`âŒ å„²å­˜é ç®—å¤±æ•—: ${error.message}`);
                saveBudgetBtn.textContent = 'å„²å­˜é ç®—';
                saveBudgetBtn.disabled = false;
            }
        });

        // æŸ¥è©¢æŒ‰éˆ•äº‹ä»¶
        loadRecordsBtn.addEventListener('click', () => {
            loadAccountingRecords();
            updateAccountingStats();
        });

        // --- åˆå§‹è¼‰å…¥ ---
        document.addEventListener('DOMContentLoaded', async () => {
            const savedSecret = getAdminSecret();
            if (savedSecret) {
                const isValid = await verifyPassword(savedSecret);
                if (isValid) {
                    loginModal.classList.add('hidden');
                    mainContent.style.display = 'block';
                    setTodayAsDefault();
                    loadBudget();
                } else {
                    sessionStorage.removeItem('adminSecret');
                    loginModal.classList.remove('hidden');
                }
            } else {
                loginModal.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
